<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Suivi Connaissance & PrÃ©paration VKPC</title>
<style>
:root{
  --bg:#f7f7f8;
  --card:#ffffff;
  --text:#111827;
  --muted:#6b7280;
  --primary:#4B5563;
  --accent:#0ea5a4;
  --green:#16a34a;
  --orange:#f59e0b;
  --red:#ef4444;
  --border: rgba(17,24,39,0.06);
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);padding:16px;display:flex;justify-content:center;min-height:100vh;}
.app{width:100%;max-width:980px;}
.header{display:flex;justify-content:space-between;align-items:start;gap:12px;margin-bottom:12px;flex-wrap:wrap}
.title{font-size:20px;font-weight:700;color:var(--primary)}
.subtitle{font-size:13px;color:var(--muted)}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(16,24,40,0.04)}
.tabs{display:flex;gap:8px;margin-bottom:12px}
.tab{flex:1;padding:10px;border-radius:10px;background:#eef2f6;border:none;color:var(--primary);font-weight:700;cursor:pointer}
.tab.active{background:var(--primary);color:#fff;box-shadow:0 6px 18px rgba(16,24,40,0.06)}
.user-form{display:flex;gap:8px;align-items:center;margin-bottom:12px}
input[type="text"], input[type="date"]{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--text);font-size:14px}
.btn{padding:8px 12px;border-radius:10px;border:0;font-weight:700;cursor:pointer;font-size:14px}
.btn-primary{background:var(--primary);color:#fff}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
.small{font-size:13px;padding:6px 10px}
.table{width:100%;border-collapse:collapse;font-size:14px}
.table th{background:transparent;padding:10px 8px;text-align:left;color:var(--muted);font-weight:700}
.table td{padding:10px 8px;border-top:1px solid var(--border);vertical-align:middle}
.name{font-weight:700}
.dateText{color:var(--muted);font-size:13px}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.codeLegend{color:var(--muted);font-size:13px;margin-left:auto}
.status{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-weight:700;color:white;font-size:13px}
.status .dot{width:10px;height:10px;border-radius:50%}
.modal{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.45);backdrop-filter:blur(2px);justify-content:center;align-items:center;padding:16px;z-index:60}
.modal-inner{background:var(--card);border-radius:12px;padding:14px;max-width:520px;width:100%;box-shadow:0 10px 40px rgba(2,6,23,0.12)}
.modal-inner h3{margin-top:0}
.checklist-list{list-style:none;padding:0;margin:8px 0}
.checklist-list li{padding:6px 0;border-bottom:1px dashed rgba(0,0,0,0.04)}
.toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:var(--accent);color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 6px 20px rgba(16,24,40,0.2);opacity:0;pointer-events:none;transition:opacity 0.3s}
.toast.show{opacity:1;pointer-events:auto}
#loader{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.5);backdrop-filter:blur(2px);display:flex;justify-content:center;align-items:center;font-size:18px;color:var(--primary)}

@media (max-width:680px){
  .tabs{flex-direction:row}
  .table, thead, tbody, th, td, tr{display:block;width:100%}
  thead{display:none}
  tbody tr{display:flex;flex-direction:column;padding:10px;margin-bottom:8px;border-radius:10px;background:var(--card);box-shadow:0 6px 20px rgba(2,6,23,0.04)}
  td{display:flex;justify-content:space-between;align-items:center;padding:8px}
  td[data-label]:before{content:attr(data-label);color:var(--muted);font-weight:700;margin-right:8px;flex-basis:40%}
  .controls{flex-direction:column;align-items:flex-start}
  .user-form{flex-direction:column;align-items:stretch}
}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div>
      <div class="title">Suivi Connaissance â€“ VKPC</div>
      <div class="subtitle">Onglets : Suivi & PrÃ©paration (check-lists par engin)</div>
    </div>
    <div class="dateInfo codeLegend" id="lastOpened">DerniÃ¨re ouverture : â€”</div>
  </div>

  <div class="tabs" role="tablist">
    <button class="tab active" data-tab="connaissance">Suivi Connaissance</button>
    <button class="tab" data-tab="preparation">PrÃ©paration VKPC</button>
  </div>

  <section id="tab-connaissance" class="card tab-content active">
    <div class="user-form">
      <input id="sncbInput" type="text" placeholder="NumÃ©ro SNCB (ex: 372589002)" />
      <button id="sncbConfirm" class="btn btn-primary">Valider</button>
      <button id="logoutBtn" class="btn btn-ghost">DÃ©connexion</button>
      <div style="flex:1"></div>
      <div class="codeLegend">Codes : ðŸŸ¢ &lt;9 mois â€” ðŸŸ  9â€“11 â€” ðŸ”´ â‰¥12</div>
    </div>
    <div id="loader">Chargement...</div>
    <table class="table">
      <thead><tr><th>Engin</th><th>Dernier parcours</th><th style="width:260px;text-align:right">Actions</th></tr></thead>
      <tbody id="enginesBody"></tbody>
    </table>
  </section>

  <section id="tab-preparation" class="card tab-content" style="display:none">
    <h3 style="margin:0 0 8px 0">PrÃ©paration VKPC â€” check-lists</h3>
    <p style="margin:0 0 12px 0;color:var(--muted)">Ouvre la check-list spÃ©cifique Ã  l'engin pour l'afficher.</p>
    <table class="table">
      <thead><tr><th>Engin</th><th style="text-align:right">Check-list</th></tr></thead>
      <tbody id="prepBody"></tbody>
    </table>
  </section>
</div>

<div id="checklistModal" class="modal">
  <div class="modal-inner">
    <h3 id="modalTitle">PrÃ©paration</h3>
    <ul id="checklistItems" class="checklist-list"></ul>
    <div style="display:flex;justify-content:flex-end;margin-top:10px">
      <button id="closeModalBtn" class="btn btn-ghost">Fermer</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBtRfiPJXTd-_RA73DPMpAcd15P7TcwHy0",
  authDomain: "app-suivi-29ec4.firebaseapp.com",
  projectId: "app-suivi-29ec4",
  storageBucket: "app-suivi-29ec4.firebasestorage.app",
  messagingSenderId: "843017578863",
  appId: "1:843017578863:web:9a49335b7a2699986ae09a"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const ENGINES = ['HLE18','HLE13','M7','HVR M6','HVR i1','AM08','Micheline'];
const CHECKLISTS = {
  "HLE18":["Inspection caisse & pantographes","Test disjoncteur","Test freins & compresseur","ContrÃ´le radio","ContrÃ´le sÃ©curitÃ©"],
  "HLE13":["Pantographes","Test tension ligne","ContrÃ´le relais traction","Ã‰clairage cabine","Radio sol-train"],
  "M7":["Inspection train","Test freins & portes","VÃ©rif coupleur","ContrÃ´le HVAC","Activation PIS"],
  "HVR M6":["Frein direct/indirect","Portes voyageurs","ContrÃ´le bogies","Test traction Ã  vide","Ã‰clairage front"],
  "HVR i1":["Frein de parc","Batteries 24V","Compresseur","Essuie-glaces & phares","Radio & avertisseur"],
  "AM08":["Inspection caisse","Pantographes","Test frein","ContrÃ´le TBL1+","Feux signalisation"],
  "Micheline":["ContrÃ´le carrosserie","Niveaux huile/carburant","Test klaxon & feux","Pneus & freins","Essai moteur"]
};

const todayISO = new Date().toISOString().slice(0,10);
const enginesBody = document.getElementById('enginesBody');
const prepBody = document.getElementById('prepBody');
const modal = document.getElementById('checklistModal');
const modalTitle = document.getElementById('modalTitle');
const checklistItems = document.getElementById('checklistItems');
const lastOpenedEl = document.getElementById('lastOpened');
const loader = document.getElementById('loader');
const toast = document.getElementById('toast');

let numSNCB = localStorage.getItem('numSNCB') || null;

function showToast(msg){
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(()=>toast.classList.remove('show'),2000);
}

async function loadSuivi(){
  if(!numSNCB){
    enginesBody.innerHTML = '<tr><td colspan="3" style="color:var(--muted)">Saisissez votre numÃ©ro SNCB et cliquez sur Valider</td></tr>';
    lastOpenedEl.textContent = 'DerniÃ¨re ouverture : â€”';
    loader.style.display='none';
    return;
  }
  loader.style.display='flex';
  try{
    const ref = doc(db, 'conducteurs', numSNCB);
    const snap = await getDoc(ref);
    const data = snap.exists() ? snap.data() : {};

    enginesBody.innerHTML = '';
    ENGINES.forEach(engine=>{
      const tr = document.createElement('tr');

      const tdName = document.createElement('td'); tdName.setAttribute('data-label','Engin'); tdName.innerHTML=`<div class="name">${engine}</div>`;
      const tdDateText = document.createElement('td'); tdDateText.setAttribute('data-label','Dernier parcours'); tdDateText.innerHTML = data[engine]?`<div class="dateText">${data[engine]}</div>`:`<div class="dateText">â€”</div>`;

      const tdActions = document.createElement('td'); tdActions.setAttribute('data-label','Actions');
      const dateInput = document.createElement('input'); dateInput.type='date'; dateInput.value = data[engine] || todayISO;

      const saveBtn = document.createElement('button'); saveBtn.className='btn btn-ghost small'; saveBtn.textContent='Enregistrer';
      saveBtn.onclick = async ()=>{
        const val = dateInput.value || todayISO;
        try{
          await setDoc(doc(db,'conducteurs',numSNCB), {[engine]: val}, {merge:true});
          await loadSuivi();
          showToast(`Date enregistrÃ©e pour ${engine}`);
        }catch(e){alert('Erreur connexion base'); console.error(e);}
      };

      const todayBtn = document.createElement('button'); todayBtn.className='btn btn-primary small'; todayBtn.textContent="Parcouru aujourd'hui";
      todayBtn.onclick = async ()=>{
        try{
          await setDoc(doc(db,'conducteurs',numSNCB), {[engine]: todayISO}, {merge:true});
          await loadSuivi();
          showToast(`${engine} marquÃ© comme parcouru aujourd'hui`);
        }catch(e){alert('Erreur connexion base'); console.error(e);}
      };

      const container = document.createElement('div'); container.className='controls';
      container.append(dateInput,saveBtn,todayBtn);
      tdActions.appendChild(container);

      tr.append(tdName, tdDateText, tdActions);
      enginesBody.appendChild(tr);
    });

    lastOpenedEl.textContent = 'DerniÃ¨re ouverture : ' + new Date().toLocaleString();
  }catch(e){alert('Erreur connexion base'); console.error(e);}
  loader.style.display='none';
}

function loadPreparation(){
  prepBody.innerHTML = '';
  ENGINES.forEach(e=>{
    const tr=document.createElement('tr');
    const td1=document.createElement('td'); td1.textContent=e;
    const td2=document.createElement('td'); td2.style.textAlign='right';
    const openBtn=document.createElement('button'); openBtn.className='btn btn-primary small'; openBtn.textContent='Ouvrir la check-list';
    openBtn.onclick=()=>openChecklist(e);
    td2.appendChild(openBtn); tr.append(td1,td2); prepBody.appendChild(tr);
  });
}

function openChecklist(engine){
  modalTitle.textContent=`PrÃ©paration â€” ${engine}`;
  checklistItems.innerHTML='';
  (CHECKLISTS[engine]||['Aucune check-list dÃ©finie']).forEach(it=>{
    const li=document.createElement('li');
    li.innerHTML=`<label style="display:flex;gap:10px;align-items:center"><input type="checkbox"> <span>${it}</span></label>`;
    checklistItems.appendChild(li);
  });
  modal.style.display='flex';
}

document.getElementById('closeModalBtn').onclick=()=>modal.style.display='none';

/* Tabs */
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(s=>{s.classList.remove('active');s.style.display='none';});
    btn.classList.add('active');
    const t=btn.dataset.tab; const el=document.getElementById('tab-'+t);
    el.classList.add('active'); el.style.display='block';
    if(t==='preparation') loadPreparation();
    if(t==='connaissance') loadSuivi();
  });
});

/* SNCB input */
document.getElementById('sncbConfirm').onclick=async ()=>{
  const v=document.getElementById('sncbInput').value.trim();
  const regex=/^[0-9]{9}$/;
  if(!regex.test(v)){
    loader.style.display='none'; // <-- correction du bug
    alert('NumÃ©ro SNCB invalide. 9 chiffres requis');
    return;
  }
  loader.style.display='flex'; // loader seulement si numÃ©ro correct
  numSNCB=v; localStorage.setItem('numSNCB',v);
  await loadSuivi();
};

document.getElementById('logoutBtn').onclick=()=>{
  localStorage.removeItem('numSNCB'); numSNCB=null;
  document.getElementById('sncbInput').value='';
  enginesBody.innerHTML='';
  lastOpenedEl.textContent='DerniÃ¨re ouverture : â€”';
};

/* auto-login */
if(localStorage.getItem('numSNCB')){ document.getElementById('sncbInput').value=localStorage.getItem('numSNCB'); document.getElementById('sncbConfirm').click(); }
</script>
</body>
</html>
