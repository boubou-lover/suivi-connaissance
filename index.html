<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Suivi Connaissance â€“ MatÃ©riel Ferroviaire</title>
<style>
:root{
  --bg:#f5f5f5;
  --card:#ffffff;
  --text:#202124;
  --muted:#5f6368;
  --primary:#1e88e5;
  --accent:#03dac6;
  --green:#03dac6;
  --orange:#ffb300;
  --red:#cf6679;
  --button-hover:rgba(30,136,229,0.1);
  font-family:'Roboto',sans-serif;
}
*{box-sizing:border-box;transition: all 0.2s ease;}
body{margin:0;background:var(--bg);color:var(--text);padding:16px;display:flex;justify-content:center;font-family:Roboto,sans-serif;}
.app{width:100%;max-width:900px;}
header{margin-bottom:16px;}
.title{font-weight:700;font-size:24px;color:var(--text);}
.subtitle{font-size:14px;color:var(--muted);}
.last-open{font-size:13px;color:var(--muted);margin-top:4px;}
.card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
table{width:100%;border-collapse:collapse;font-size:14px;}
thead th{text-align:left;padding:10px 6px;color:var(--muted);font-weight:500;font-size:13px;}
tbody td{padding:8px 6px;border-top:1px solid rgba(0,0,0,0.05);}
.name{font-weight:600;}
.date{color:var(--muted);}
.status{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:10px;font-weight:500;font-size:12px;color:white;}
.status-icon{width:8px;height:8px;border-radius:50%;display:inline-block;}
.btn{padding:6px 12px;border-radius:10px;border:none;font-weight:600;font-size:13px;cursor:pointer;transition:all 0.2s;}
.btn-primary{background:var(--primary);color:white;}
.btn-primary:hover{background:var(--button-hover);}
.btn-secondary{background:transparent;border:1px solid var(--muted);color:var(--text);}
.btn-secondary:hover{background:rgba(0,0,0,0.05);}
input[type="date"], input[type="text"]{padding:5px 8px;border-radius:10px;border:1px solid rgba(0,0,0,0.1);background:#fafafa;color:var(--text);}
input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 4px var(--accent);}
.actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
.user-form{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;}
footer{margin-top:12px;color:var(--muted);font-size:12px;text-align:center;}

/* Responsive mobile avec data-label */
@media (max-width:640px){
  thead{display:none;}
  table, tbody, thead, tr, td{display:block;width:100%;}
  tbody tr{display:flex;flex-direction:column;padding:8px 0;margin-bottom:6px;background:#ffffff;border-radius:10px;box-shadow:0 1px 4px rgba(0,0,0,0.05);}
  td{display:flex;justify-content:space-between;align-items:center;padding:4px 6px;position:relative;}
  td:before{
    content:attr(data-label);
    font-weight:600;
    color: var(--muted);
    display:inline-block;
    width:120px;
    flex-shrink:0;
  }
  .action-group{flex-direction:column;gap:4px;align-items:flex-start;margin-top:4px;}
}
</style>
</head>
<body>
<div class="app">
<header>
  <div>
    <div class="title">Suivi Connaissance â€“ MatÃ©riel Ferroviaire</div>
    <div class="subtitle">Vue rapide â€” mise Ã  jour automatique</div>
  </div>
  <div class="last-open" id="lastOpened">DerniÃ¨re ouverture : â€”</div>
</header>

<!-- Champ numÃ©ro SNCB -->
<div class="card user-form">
  <input type="text" id="sncbInput" placeholder="Entrez votre numÃ©ro SNCB" aria-label="NumÃ©ro SNCB">
  <button id="sncbConfirm" class="btn btn-primary small">Valider</button>
</div>

<section class="card">
<h3 style="margin:0 0 12px 0">Liste des engins</h3>
<table>
<thead>
<tr>
<th>Engin</th>
<th>Dernier parcours</th>
<th>Temps Ã©coulÃ©</th>
<th style="text-align:right">Action</th>
</tr>
</thead>
<tbody id="engines"></tbody>
</table>
<div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
  <input type="text" id="newEngine" placeholder="Ajouter engin" class="small" aria-label="Ajouter engin"/>
  <button id="addEngine" class="btn btn-primary small">Ajouter</button>
  <button id="resetAll" class="btn btn-secondary small">RÃ©initialiser toutes les dates</button>
  <div style="flex:1"></div>
  <div class="muted">Codes : ðŸŸ¢ &lt;9 mois â€” ðŸŸ  9â€“11 â€” ðŸ”´ â‰¥12</div>
</div>
</section>

<footer class="muted">Chaque utilisateur a ses donnÃ©es individuelles stockÃ©es dans Firestore.</footer>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBtRfiPJXTd-_RA73DPMpAcd15P7TcwHy0",
  authDomain: "app-suivi-29ec4.firebaseapp.com",
  projectId: "app-suivi-29ec4",
  storageBucket: "app-suivi-29ec4.firebasestorage.app",
  messagingSenderId: "843017578863",
  appId: "1:843017578863:web:9a49335b7a2699986ae09a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let numSNCB = null;
const enginesList = ['HLE18','HLE13','M7','HVR M6','HVR i1','AM08','Micheline'];
let data = {};

document.getElementById('sncbConfirm').onclick = async () => {
  const input = document.getElementById('sncbInput').value.trim();
  if(!input) return alert("Entrez votre numÃ©ro SNCB !");
  numSNCB = input;
  localStorage.setItem('numSNCB', numSNCB);
  await loadEngines();
  document.querySelector('.user-form').style.display = 'none';
};

async function loadEngines(){
  const docRef = doc(db, 'conducteurs', numSNCB);
  const docSnap = await getDoc(docRef);
  if(docSnap.exists()){ 
    data = docSnap.data(); 
  }
  renderTable();
}

function diffMonthsDays(start,end){
  if(!start || start> end) return {months:0,days:0};
  let years = end.getFullYear()-start.getFullYear();
  let months = end.getMonth()-start.getMonth()+years*12;
  let dayDiff=end.getDate()-start.getDate();
  if(dayDiff<0){months--; const temp=new Date(start.getFullYear(),start.getMonth()+months,start.getDate()); dayDiff=Math.round((end-temp)/86400000);}
  return {months:Math.max(0,months),days:Math.max(0,dayDiff)};
}

function renderTable(){
  if(!numSNCB) return;
  document.getElementById('lastOpened').textContent = 'DerniÃ¨re ouverture : '+new Date().toISOString().slice(0,10);
  const tbody=document.getElementById('engines'); tbody.innerHTML='';
  enginesList.forEach(e=>{
    const tr=document.createElement('tr');
    const tdName=document.createElement('td'); tdName.setAttribute('data-label','Engin'); tdName.innerHTML='<div class="name">'+e+'</div>';
    const tdDate=document.createElement('td'); tdDate.setAttribute('data-label','Dernier parcours'); tdDate.innerHTML=data[e]?'<div class="date">'+data[e]+'</div>':'<div class="date">â€”</div>';
    const tdElapsed=document.createElement('td'); tdElapsed.setAttribute('data-label','Temps Ã©coulÃ©');
    const span=document.createElement('span'); span.className='status';
    const icon=document.createElement('span'); icon.className='status-icon';
    if(data[e]){
      const diff=diffMonthsDays(new Date(data[e]),new Date());
      span.textContent=diff.months+' mois'+(diff.days>0?' et '+diff.days+' j':'');
      if(diff.months>=12){span.style.background='var(--red)'; icon.style.background='var(--red)';}
      else if(diff.months>=9){span.style.background='var(--orange)'; icon.style.background='var(--orange)';}
      else {span.style.background='var(--green)'; icon.style.background='var(--green)';}
    } else {span.textContent='Aucune donnÃ©e'; span.style.background='rgba(0,0,0,0.1)'; span.style.color='var(--text)'; icon.style.background='rgba(0,0,0,0.3)';}
    span.prepend(icon); tdElapsed.appendChild(span);

    const tdAction=document.createElement('td'); tdAction.setAttribute('data-label','Action'); tdAction.style.textAlign='right'; tdAction.className='action-group';
    const btnToday=document.createElement('button'); btnToday.textContent='Parcouru aujourd\'hui'; btnToday.className='btn btn-primary small';
    btnToday.onclick=async ()=>{
      const today=new Date().toISOString().slice(0,10);
      data[e]=today;
      await setDoc(doc(db,'conducteurs',numSNCB),{[e]:today},{merge:true});
      renderTable();
    };
    const inputDate=document.createElement('input'); inputDate.type='date'; inputDate.value=data[e]||'';
    inputDate.onchange=async ()=>{
      if(inputDate.value){
        data[e]=inputDate.value;
        await setDoc(doc(db,'conducteurs',numSNCB),{[e]:inputDate.value},{merge:true});
        renderTable();
      }
    };

    tdAction.appendChild(btnToday);
    tdAction.appendChild(inputDate);
    tr.appendChild(tdName); tr.appendChild(tdDate); tr.appendChild(tdElapsed); tr.appendChild(tdAction);
    tbody.appendChild(tr);
  });
}

document.getElementById('addEngine').onclick=async ()=>{
  const val=document.getElementById('newEngine').value.trim();
  if(!val) return;
  if(!enginesList.includes(val)) enginesList.push(val);
  data[val] = null;
  document.getElementById('newEngine').value='';
  renderTable();
  if(numSNCB) await setDoc(doc(db,'conducteurs',numSNCB),{[val]:null},{merge:true});
};

document.getElementById('resetAll').onclick=async ()=>{
  if(!numSNCB) return alert("NumÃ©ro SNCB requis");
  if(!confirm('RÃ©initialiser toutes les dates ?')) return;
  enginesList.forEach(e=>data[e]=null);
  renderTable();
  await setDoc(doc(db,'conducteurs',numSNCB),enginesList.reduce((acc,e)=>{acc[e]=null;return acc;},{}),{merge:true});
};

const stored = localStorage.getItem('numSNCB');
if(stored){ document.getElementById('sncbInput').value = stored; document.getElementById('sncbConfirm').click(); }
</script>
</body>
</html>
