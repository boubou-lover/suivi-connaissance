<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Suivi Connaissance â€“ MatÃ©riel Ferroviaire</title>
<style>
:root{
  --bg:#0f172a;
  --card: rgba(20,25,40,0.9);
  --muted:#94a3b8;
  --green:#16a34a;
  --orange:#f59e0b;
  --red:#ef4444;
  --accent1:#7c3aed;
  --accent2:#06b6d4;
  --text:#f1f5f9;
  font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
*{box-sizing:border-box;transition: all 0.2s ease;}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);padding:20px;display:flex;justify-content:center;}
.app{width:100%;max-width:980px;}
header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:18px;flex-wrap:wrap;gap:8px;}
.title{background:linear-gradient(90deg,var(--accent1),var(--accent2));-webkit-background-clip:text;background-clip:text;color:transparent;font-weight:700;font-size:22px;}
.subtitle{font-size:13px;color:var(--muted);margin-top:4px;}
.last-open{font-size:13px;color:var(--muted);background:rgba(255,255,255,0.1);padding:6px 12px;border-radius:12px;align-self:center;}
.card{background:var(--card);border-radius:16px;padding:16px;backdrop-filter: blur(8px);box-shadow:0 4px 20px rgba(0,0,0,0.4);}
table{width:100%;border-collapse:separate;border-spacing:0;font-size:15px;}
thead th{text-align:left;padding:12px 14px;color:var(--muted);font-weight:600;font-size:14px;}
tbody td{padding:10px 14px;border-top:1px solid rgba(255,255,255,0.1);}
.name{font-weight:700;}
.date{font-size:13px;color:var(--muted);}
.status{display:inline-block;padding:6px 12px;border-radius:999px;font-weight:700;font-size:13px;color:white;transition: background 0.3s;}
.btn{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;border:0;cursor:pointer;font-weight:700;font-size:13px;transition: transform 0.2s, background 0.2s;}
.btn:hover{transform:translateY(-2px);}
.btn-primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white;box-shadow:0 2px 8px rgba(0,0,0,0.3);}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.2);}
.actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
.small{font-size:13px;padding:6px 10px;}
.muted{color:var(--muted);}
input[type="date"]{padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.1);color:var(--text);transition: all 0.2s;}
input[type="date"]:focus{outline:none;border-color:var(--accent2);box-shadow:0 0 6px var(--accent2);}
@media (max-width:640px){
  thead{display:none}
  table,tbody,thead,tr{display:block;width:100%}
  tbody tr{display:flex;flex-direction:column;padding:10px 0;border-radius:12px;margin-bottom:8px;background:rgba(255,255,255,0.05)}
  tbody td{display:flex;justify-content:space-between;align-items:center;padding:6px 10px}
  .action-group{flex-direction:column;gap:6px;align-items:flex-start;margin-top:6px;}
}
footer{margin-top:14px;color:var(--muted);font-size:13px;text-align:center}
</style>
</head>
<body>
<div class="app">
<header>
<div>
<div class="title">Suivi Connaissance â€“ MatÃ©riel Ferroviaire</div>
<div class="subtitle">Vue rapide â€” mise Ã  jour automatique</div>
</div>
<div class="last-open" id="lastOpened">DerniÃ¨re ouverture : â€”</div>
</header>
<section class="card">
<h3 style="margin:0 0 12px 0">Liste des engins</h3>
<table>
<thead><tr><th>Engin</th><th>Dernier parcours</th><th>Temps Ã©coulÃ©</th><th style="text-align:right">Action</th></tr></thead>
<tbody id="engines"></tbody>
</table>
<div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
<input type="text" id="newEngine" placeholder="Ajouter engin" class="small" />
<button id="addEngine" class="btn btn-primary small">Ajouter</button>
<button id="resetAll" class="btn btn-ghost small">RÃ©initialiser toutes les dates</button>
<div style="flex:1"></div>
<div class="muted">Codes : ðŸŸ¢ &lt;9 mois â€” ðŸŸ  9â€“11 â€” ðŸ”´ â‰¥12</div>
</div>
</section>
<footer class="muted">Chaque utilisateur a ses donnÃ©es individuelles stockÃ©es dans Firestore.</footer>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

// ======= FIREBASE CONFIG =======
const firebaseConfig = {
  apiKey: "AIzaSyBtRfiPJXTd-_RA73DPMpAcd15P7TcwHy0",
  authDomain: "app-suivi-29ec4.firebaseapp.com",
  projectId: "app-suivi-29ec4",
  storageBucket: "app-suivi-29ec4.firebasestorage.app",
  messagingSenderId: "843017578863",
  appId: "1:843017578863:web:9a49335b7a2699986ae09a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ======= LOGIQUE DE L'APP =======
let numSNCB = localStorage.getItem('numSNCB');
async function askUser(){
  numSNCB = prompt('Entrez votre numÃ©ro SNCB :', numSNCB || '');
  if(!numSNCB) return askUser();
  localStorage.setItem('numSNCB', numSNCB);
  await loadEngines();
}

let enginesList = ['HLE18','HLE13','M7','HVR M6','HVR i1','AM08','Micheline'];
let data = {};

async function loadEngines(){
  const docRef = doc(db, 'conducteurs', numSNCB);
  const docSnap = await getDoc(docRef);
  if(docSnap.exists()){ 
    data = docSnap.data(); 
    enginesList = Array.from(new Set([...enginesList,...Object.keys(data)])); 
  }
  renderTable();
}

function diffMonthsDays(start,end){
  if(!start || start> end) return {months:0,days:0};
  let years = end.getFullYear()-start.getFullYear();
  let months = end.getMonth()-start.getMonth()+years*12;
  let dayDiff=end.getDate()-start.getDate();
  if(dayDiff<0){months--; const temp=new Date(start.getFullYear(),start.getMonth()+months,start.getDate()); dayDiff=Math.round((end-temp)/86400000);}
  return {months:Math.max(0,months),days:Math.max(0,dayDiff)};
}

function renderTable(){
  document.getElementById('lastOpened').textContent = 'DerniÃ¨re ouverture : '+new Date().toISOString().slice(0,10);
  const tbody=document.getElementById('engines'); tbody.innerHTML='';
  enginesList.forEach(e=>{
    const tr=document.createElement('tr');
    const tdName=document.createElement('td'); tdName.innerHTML='<div class="name">'+e+'</div>';
    const tdDate=document.createElement('td'); tdDate.innerHTML=data[e]?'<div class="date">'+data[e]+'</div>':'<div class="date">â€”</div>';
    const tdElapsed=document.createElement('td'); 
    const span=document.createElement('span'); span.className='status';
    if(data[e]){
      const diff=diffMonthsDays(new Date(data[e]),new Date());
      span.textContent=diff.months+' mois'+(diff.days>0?' et '+diff.days+' j':'');
      if(diff.months>=12) span.style.background='var(--red)';
      else if(diff.months>=9) span.style.background='var(--orange)';
      else span.style.background='var(--green)';
    } else {span.textContent='Aucune donnÃ©e'; span.style.background='rgba(255,255,255,0.1)'; span.style.color='#f1f5f9';}
    tdElapsed.appendChild(span);

    const tdAction=document.createElement('td'); tdAction.style.textAlign='right'; tdAction.className='action-group';
    const btnToday=document.createElement('button'); btnToday.textContent='Parcouru aujourd\'hui'; btnToday.className='btn btn-primary small';
    btnToday.onclick=async ()=>{
      const today=new Date().toISOString().slice(0,10);
      data[e]=today;
      await setDoc(doc(db,'conducteurs',numSNCB),{[e]:today},{merge:true});
      renderTable();
    };
    const inputDate=document.createElement('input'); inputDate.type='date'; inputDate.value=data[e]||'';
    inputDate.onchange=async ()=>{
      if(inputDate.value){
        data[e]=inputDate.value;
        await setDoc(doc(db,'conducteurs',numSNCB),{[e]:inputDate.value},{merge:true});
        renderTable();
      }
    };

    tdAction.appendChild(btnToday);
    tdAction.appendChild(inputDate);
    tr.appendChild(tdName); tr.appendChild(tdDate); tr.appendChild(tdElapsed); tr.appendChild(tdAction);
    tbody.appendChild(tr);
  });
}

// ======= BOUTONS =======
document.getElementById('addEngine').onclick=async ()=>{
  const val=document.getElementById('newEngine').value.trim();
  if(!val) return;
  if(!enginesList.includes(val)) enginesList.push(val);
  data[val] = null;
  document.getElementById('newEngine').value='';
  renderTable();
  await setDoc(doc(db,'conducteurs',numSNCB),{[val]:null},{merge:true});
};

document.getElementById('resetAll').onclick=async ()=>{
  if(!confirm('RÃ©initialiser toutes les dates ?')) return;
  enginesList.forEach(e=>data[e]=null);
  renderTable();
  await setDoc(doc(db,'conducteurs',numSNCB),enginesList.reduce((acc,e)=>{acc[e]=null;return acc;},{}),{merge:true});
};

// ======= DEMARRAGE =======
askUser();
</script>
</body>
</html>
